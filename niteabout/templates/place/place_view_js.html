<script type="text/javascript">
var initialLocation;
var directionsDisplay;
var directionService = new google.maps.DirectionsService();

function initialize() {
    var mapOptions = {
        {% for place in event.locations.all %}
        {% if forloop.first %}
        center: new google.maps.LatLng( {{ place.geom.y }}, {{ place.geom.x }} ),
        {% endif %}
        {% endfor %}
        zoom: 16,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
    
    directionsDisplay = new google.maps.DirectionsRenderer();
    directionsDisplay.setMap(map);
    calcRoute();
}

function calcRoute() {
    {% for place in event.locations.all %}
    {% if forloop.first %}
    var start = new google.maps.LatLng( {{ place.geom.y }}, {{ place.geom.x }} );
    {% endif %}
    {% endfor %}

    {% for place in event.locations.all %}
    {% if forloop.last %}
    var end = new google.maps.LatLng( {{ place.geom.y }}, {{ place.geom.x }} );
    {% endif %}
    {% endfor %}
    var request = {
        origin: start,
        destination: end,
        waypoints: [ 
                     {% for place in event.locations.all %}
                     { 
                        location: new google.maps.LatLng( {{ place.geom.y }}, {{ place.geom.x }} ),
                        stopover: true
                     },
                     {% endfor %}
                   ],
        travelMode: google.maps.TravelMode.WALKING
    };
    directionService.route(request, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(result);
            $('#totalDistance').text(result.routes[0].legs[0].distance.text);
            }
            });
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>
